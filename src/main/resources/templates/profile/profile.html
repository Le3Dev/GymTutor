<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

  <body>

    <h1>Meu Perfil</h1>

    <!-- Mensagens de erro e sucesso -->
    <div th:if="${successMessage}" style="color: green;">
      <p th:text="${successMessage}"></p>
    </div>
    <div th:if="${errorMessage}" style="color: red;">
      <p th:text="${errorMessage}"></p>
    </div>

    <!-- Informações do usuário -->
    <div style="display: flex; flex-direction: column; align-items: center">

      <img th:src="@{/images/users/{id}/profile.jpg(id=${user.userId})}"
           alt="Imagem de perfil"
           onerror="this.onerror=null; this.src='/images/users/nophoto.jpg';"
           style="width: 150px; height: 150px; object-fit: cover;" />

      <div style="display: flex; flex-direction: column">
        <button onclick="openPhotoModal()">Alterar Foto</button>

        <h2 th:text="'Nome: ' + ${user.userName}"></h2>
        <button type="button" onclick="openNameModal()">Alterar Nome</button>
        <h2 th:text="'Tipo de Conta: ' + ${user.role.roleName.displayName}"></h2>
        <h3 th:text="'Login: ' + ${user.userEmail}"></h3>
        <H3 th:text="'CPF: ' + ${user.userCpf}"></H3>

        <!-- Se o usuário já tem CREF e não for Administrador -->
        <div th:if="${personal != null}">
          <h3 th:text="'CREF: ' + ${personal.personalCREF} + '/' + ${personal.state} "></h3>
          <div th:if="${crefMessage}" style="color: red;">
            <p th:text="${crefMessage}"></p>
          </div>
          <form id="removeCrefForm" th:action="@{/profile/remove-cref}" th:method="post" style="display: inline;">
            <input type="hidden" name="confirmPassword2" id="confirmPassword2">
            <button type="button" onclick="confirmRemoveCref()">Remover CREF</button>
          </form>
        </div>

        <!-- Se o usuário ainda NÃO tem CREF -->
        <div th:if="${personal == null and user.role.roleName.displayName == 'Aluno'}">
          <button onclick="openCrefModal()">Cadastrar CREF</button>
        </div>


        <div class="actions-cell">

          <form th:action="@{/profile/change-password}" th:method="get" style="display: inline;">
            <button type="submit">Alterar Senha</button>
          </form>


          <form id="disableForm" th:action="@{/profile/disable-account}" th:method="post" style="display: inline;">
            <input type="hidden" name="confirmPassword" id="confirmPassword">
            <button type="button" onclick="confirmDisable()">Desativar Conta</button>
          </form>

        </div>
      </div>

    </div>


  <!-- Modal para adicionar CREF -->
  <div id="crefModal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
                           background: #fff; padding: 20px; border: 1px solid #ccc; z-index: 1000;">

    <h3>Insira seu CREF e Estado</h3>
    <form th:action="@{/profile/save-cref}" th:object="${personalCrefDTO}" method="post">

      <input type="text" th:field="*{personalCREF}" placeholder="Digite seu CREF"
             required pattern="^\d{1,6}-[GPC]$" title="O CREF deve conter de 1 a 6 dígitos seguidos de um hífen e uma letra (G, P ou C). Exemplo: 12345-G" />
      <br><br>

      <div th:if="${#fields.hasErrors('personalCREF')}" style="color: red;">
        <p th:errors="*{personalCREF}"></p>
      </div>

      <select th:field="*{state}" required>
        <option value="" disabled selected>Selecione o Estado</option>
        <option th:each="state : ${states}" th:value="${state}" th:text="${state}"></option>
      </select>

      <div th:if="${#fields.hasErrors('state')}" style="color: red;">
        <p th:errors="*{state}"></p>
      </div>

      <br><br>
      <button type="submit">Salvar</button>
      <button type="button" onclick="closeCrefModal()">Cancelar</button>
    </form>
  </div>

  <!-- Overlay para escurecer o fundo -->
  <div id="crefOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%;
                             height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeCrefModal()"></div>


    <!-- Script do Modal para adicionar Cref -->
  <script>
    function openCrefModal() {
      document.getElementById("crefModal").style.display = "block";
      document.getElementById("crefOverlay").style.display = "block";
    }

    function closeCrefModal() {
      document.getElementById("crefModal").style.display = "none";
      document.getElementById("crefOverlay").style.display = "none";
    }
  </script>


    <!-- Modal de Upload de Foto -->
    <div id="photoModal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
                           background: #fff; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
      <h3>Alterar Foto de Perfil</h3>
      <form th:action="@{/profile/upload-photo}" method="post" enctype="multipart/form-data">
        <img id="imagePreview"
             th:src="@{/images/users/{id}/profile.jpg(id=${user.userId})}"
             alt="Pré-visualização da imagem"
             style="max-width: 150px; max-height: 150px; object-fit: cover; display: block; margin-bottom: 10px;"
             onerror="this.onerror=null; this.src='/images/users/nophoto.jpg';" />
        <input type="file" name="image" accept="image/*" required onchange="previewImage(event)" />
        <br><br>
        <button type="submit">Enviar</button>
        <button type="button" onclick="closePhotoModal()">Cancelar</button>
      </form>
    </div>

    <!-- Overlay -->
    <div id="photoOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%;
                             height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closePhotoModal()"></div>

    <script>
      function openPhotoModal() {
        document.getElementById("photoModal").style.display = "block";
        document.getElementById("photoOverlay").style.display = "block";
      }

      function closePhotoModal() {
        document.getElementById("photoModal").style.display = "none";
        document.getElementById("photoOverlay").style.display = "none";
      }

      function previewImage(event) {
        var file = event.target.files[0];
        var reader = new FileReader();

        reader.onload = function(e) {
          var preview = document.getElementById('imagePreview');
          preview.src = e.target.result;
          preview.style.display = 'block';
        }

        if (file.size > 5 * 1024 * 1024) {
          alert("O tamanho da imagem não pode exceder 5MB.");
          document.getElementById('imagePreview').style.display = 'none';
          event.target.value = ""; // limpa o input de arquivo
        } else {
          reader.readAsDataURL(file);
        }
      }
    </script>


    <!-- Modal para trocar o nome -->
    <div id="nameModal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
                     background: #fff; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
      <h3>Alterar Nome</h3>
      <form th:action="@{/profile/change-name}" th:object="${changeNameForm}" method="post">
        <input type="text" th:field="*{newName}" placeholder="Novo nome" required />
        <input type="password" th:field="*{confirmPassword3}" placeholder="Senha atual" required />
        <br><br>
        <button type="submit">Salvar</button>
        <button type="button" onclick="closeNameModal()">Cancelar</button>
      </form>
    </div>

    <!-- Overlay -->
    <div id="nameOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%;
                         height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeNameModal()"></div>

    <script>
      function openNameModal() {
        document.getElementById("nameModal").style.display = "block";
        document.getElementById("nameOverlay").style.display = "block";
      }

      function closeNameModal() {
        document.getElementById("nameModal").style.display = "none";
        document.getElementById("nameOverlay").style.display = "none";
      }
    </script>


  <!-- Script da desativação de conta -->
  <script>
    function confirmDisable() {
      const senha = prompt("Por favor, digite sua senha para confirmar:");

      if (senha !== null && senha.trim() !== "") {
        document.getElementById("confirmPassword").value = senha;
        if (confirm("Você tem certeza de que deseja desativar sua conta?")) {
          document.getElementById("disableForm").submit();
        }
      } else {
        alert("A senha é obrigatória para desativar a conta.");
      }
    }
  </script>

  <!-- Script da remoção do CREF -->
  <script>
    function confirmRemoveCref() {
      const senha = prompt("Por favor, digite sua senha para confirmar:");

      if (senha !== null && senha.trim() !== "") {
        document.getElementById("confirmPassword2").value = senha;
        if (confirm("Você tem certeza de que deseja remover seu CREF? você pode cadastra-lo novamente depois, " +
                "mas sem CREF sua conta voltará a ser de Aluno")) {
          document.getElementById("removeCrefForm").submit();
        }
      } else {
        alert("A senha é obrigatória para remover seu CREF.");
      }
    }
  </script>

  <script th:inline="javascript">
    /*<![CDATA[*/
    var shouldOpenCrefModal = [[${openCrefModal}]];
    if (shouldOpenCrefModal) {
      openCrefModal();
    }
    /*]]>*/
  </script>

</html>