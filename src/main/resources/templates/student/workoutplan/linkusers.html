<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Vincular Usuários</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

</head>
<body>

<h1>Vincular Usuários à Ficha:
  <span th:text="${workoutPlan.workoutPlanName}"></span>
</h1>

<a th:href="@{/student/workoutplan}">Voltar</a>
<br><br>

<!-- Mensagens -->
<p id="successMessage" style="color: green; display: none;">
  Usuário vinculado/desvinculado com sucesso!
</p>
<div th:if="${successMessage}" style="color: green;">
  <p th:text="${successMessage}"></p>
</div>
<div th:if="${errorMessage}" style="color: red;">
  <p th:text="${errorMessage}"></p>
</div>

<!-- Lista de usuários já vinculados -->
<h2>Usuários já vinculados</h2>
<div th:if="${#lists.isEmpty(linkedUsers)}">
  <p>Nenhum usuário vinculado ainda.</p>
</div>
<div th:if="${!#lists.isEmpty(linkedUsers)}" class="scrollable-table-small">
  <table>
    <thead>
    <tr>
      <th>Nome</th>
      <th>Email</th>
      <th>Ações</th>
    </tr>
    </thead>
    <tbody class="linked-users">
    <tr th:each="user : ${linkedUsers}"
        th:attr="data-user-id=${user.userId}">
      <td th:text="${user.userName}"></td>
      <td th:text="${user.userEmail}"></td>
      <td>
        <form th:action="@{'/student/workoutplan/' + ${workoutPlan.workoutPlanId} + '/linkusers/unlink'}"
              method="post">
          <input type="hidden" name="userId" th:value="${user.userId}" />
          <input type="hidden" th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}" />
          <button type="submit" class="action-button" onclick="return confirm('Você tem certeza de que deseja desvincular esta conexão?')">Desvincular</button>
        </form>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<!-- Botão que abre o modal -->
<button onclick="openModal()">Vincular um novo usuário</button>
<br><br>

<!-- Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Vincular Novo Usuário</h2>
    <p>Selecione um usuário antes de salvar.</p>

    <label for="searchBarModal">Pesquisar Usuários:</label>
    <input type="text" id="searchBarModal"
           onkeyup="filterUsersModal()"
           placeholder="Digite o nome do usuário...">
    <br><br>

    <div class="scrollable-table-big">
      <table>
        <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Ação</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}"
            th:if="${!linkedUserIds.contains(user.userId)}"
            class="modal-user-row"
            th:attr="data-user-id=${user.userId}">
          <form th:action="@{'/student/workoutplan/' + ${workoutPlan.workoutPlanId} + '/linkusers/link'}"
                method="post">
            <td th:text="${user.userName}" class="user-name"></td>
            <td th:text="${user.userEmail}"></td>
            <td>
              <input type="hidden" name="userId" th:value="${user.userId}" />
              <button type="submit">Vincular</button>
            </td>
          </form>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Scripts de abertura/fechamento e filtro -->
<script>
  function openModal() {
    document.getElementById("userModal").style.display = "block";
  }
  function closeModal() {
    document.getElementById("userModal").style.display = "none";
  }
  window.onclick = function(event) {
    const modal = document.getElementById("userModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  }
  function filterUsersModal() {
    let input = document.getElementById("searchBarModal");
    let filter = input.value.toLowerCase();
    const rows = document.querySelectorAll(".modal-user-row");
    rows.forEach(row => {
      const name = row.querySelector(".user-name").innerText.toLowerCase();
      row.style.display = name.includes(filter) ? "" : "none";
    });
  }
</script>

</body>
</html>
